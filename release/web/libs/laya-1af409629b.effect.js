!function(t,i,r){r.un,r.uns;var a=r.static,n=r.class,s=r.getset,o=(r.__newvec,laya.webgl.canvas.BlendMode),l=(laya.resource.Context,laya.display.cmd.DrawParticleCmd),u=(laya.events.Event,laya.display.Graphics,laya.resource.HTMLCanvas),h=laya.utils.Handler,m=(laya.net.Loader,laya.maths.MathUtil),c=laya.maths.Matrix,d=laya.webgl.utils.MeshParticle2D,_=laya.renders.Render,e=(laya.renders.RenderSprite,laya.webgl.utils.RenderState2D),p=laya.webgl.shader.Shader,f=laya.display.Sprite,v=laya.utils.Stat,y=laya.resource.Texture,g=laya.utils.Utils,C=laya.webgl.shader.d2.value.Value2D,x=laya.webgl.WebGL,P=(laya.webgl.WebGLContext,function(){function e(){this.textureName=null,this.textureCount=1,this.maxPartices=100,this.duration=1,this.ageAddScale=0,this.emitterVelocitySensitivity=1,this.minStartSize=100,this.maxStartSize=100,this.minEndSize=100,this.maxEndSize=100,this.minHorizontalVelocity=0,this.maxHorizontalVelocity=0,this.minVerticalVelocity=0,this.maxVerticalVelocity=0,this.endVelocity=1,this.minRotateSpeed=0,this.maxRotateSpeed=0,this.minStartRadius=0,this.maxStartRadius=0,this.minEndRadius=0,this.maxEndRadius=0,this.minHorizontalStartRadian=0,this.maxHorizontalStartRadian=0,this.minVerticalStartRadian=0,this.maxVerticalStartRadian=0,this.useEndRadian=!0,this.minHorizontalEndRadian=0,this.maxHorizontalEndRadian=0,this.minVerticalEndRadian=0,this.maxVerticalEndRadian=0,this.colorComponentInter=!1,this.disableColor=!1,this.blendState=0,this.emitterType="null",this.emissionRate=0,this.sphereEmitterRadius=1,this.sphereEmitterVelocity=0,this.sphereEmitterVelocityAddVariance=0,this.ringEmitterRadius=30,this.ringEmitterVelocity=0,this.ringEmitterVelocityAddVariance=0,this.ringEmitterUp=2,this.gravity=new Float32Array([0,0,0]),this.minStartColor=new Float32Array([1,1,1,1]),this.maxStartColor=new Float32Array([1,1,1,1]),this.minEndColor=new Float32Array([1,1,1,1]),this.maxEndColor=new Float32Array([1,1,1,1]),this.pointEmitterPosition=new Float32Array([0,0,0]),this.pointEmitterPositionVariance=new Float32Array([0,0,0]),this.pointEmitterVelocity=new Float32Array([0,0,0]),this.pointEmitterVelocityAddVariance=new Float32Array([0,0,0]),this.boxEmitterCenterPosition=new Float32Array([0,0,0]),this.boxEmitterSize=new Float32Array([0,0,0]),this.boxEmitterVelocity=new Float32Array([0,0,0]),this.boxEmitterVelocityAddVariance=new Float32Array([0,0,0]),this.sphereEmitterCenterPosition=new Float32Array([0,0,0]),this.ringEmitterCenterPosition=new Float32Array([0,0,0]),this.positionVariance=new Float32Array([0,0,0])}return n(e,"laya.particle.ParticleSetting"),e.checkSetting=function(t){var i;for(i in e._defaultSetting)t.hasOwnProperty(i)||(t[i]=e._defaultSetting[i]);t.endVelocity=+t.endVelocity,t.gravity[0]=+t.gravity[0],t.gravity[1]=+t.gravity[1],t.gravity[2]=+t.gravity[2]},a(e,["_defaultSetting",function(){return this._defaultSetting=new e}]),e}()),E=function(){function u(){this.position=null,this.velocity=null,this.startColor=null,this.endColor=null,this.sizeRotation=null,this.radius=null,this.radian=null,this.durationAddScale=NaN,this.time=NaN}return n(u,"laya.particle.ParticleData"),u.Create=function(t,i,e,a){var r=new u;r.position=i,m.scaleVector3(e,t.emitterVelocitySensitivity,u._tempVelocity);var n=m.lerp(t.minHorizontalVelocity,t.maxHorizontalVelocity,Math.random()),s=Math.random()*Math.PI*2;u._tempVelocity[0]+=n*Math.cos(s),u._tempVelocity[2]+=n*Math.sin(s),u._tempVelocity[1]+=m.lerp(t.minVerticalVelocity,t.maxVerticalVelocity,Math.random()),r.velocity=u._tempVelocity,r.startColor=u._tempStartColor,r.endColor=u._tempEndColor;var o=0;if(t.disableColor){for(o=0;o<3;o++)r.startColor[o]=1,r.endColor[o]=1;r.startColor[o]=m.lerp(t.minStartColor[o],t.maxStartColor[o],Math.random()),r.endColor[o]=m.lerp(t.minEndColor[o],t.maxEndColor[o],Math.random())}else if(t.colorComponentInter)for(o=0;o<4;o++)r.startColor[o]=m.lerp(t.minStartColor[o],t.maxStartColor[o],Math.random()),r.endColor[o]=m.lerp(t.minEndColor[o],t.maxEndColor[o],Math.random());else m.lerpVector4(t.minStartColor,t.maxStartColor,Math.random(),r.startColor),m.lerpVector4(t.minEndColor,t.maxEndColor,Math.random(),r.endColor);r.sizeRotation=u._tempSizeRotation;var l=Math.random();r.sizeRotation[0]=m.lerp(t.minStartSize,t.maxStartSize,l),r.sizeRotation[1]=m.lerp(t.minEndSize,t.maxEndSize,l),r.sizeRotation[2]=m.lerp(t.minRotateSpeed,t.maxRotateSpeed,Math.random()),r.radius=u._tempRadius;var h=Math.random();r.radius[0]=m.lerp(t.minStartRadius,t.maxStartRadius,h),r.radius[1]=m.lerp(t.minEndRadius,t.maxEndRadius,h),r.radian=u._tempRadian,r.radian[0]=m.lerp(t.minHorizontalStartRadian,t.maxHorizontalStartRadian,Math.random()),r.radian[1]=m.lerp(t.minVerticalStartRadian,t.maxVerticalStartRadian,Math.random());var c=t.useEndRadian;return r.radian[2]=c?m.lerp(t.minHorizontalEndRadian,t.maxHorizontalEndRadian,Math.random()):r.radian[0],r.radian[3]=c?m.lerp(t.minVerticalEndRadian,t.maxVerticalEndRadian,Math.random()):r.radian[1],r.durationAddScale=t.ageAddScale*Math.random(),r.time=a,r},a(u,["_tempVelocity",function(){return this._tempVelocity=new Float32Array(3)},"_tempStartColor",function(){return this._tempStartColor=new Float32Array(4)},"_tempEndColor",function(){return this._tempEndColor=new Float32Array(4)},"_tempSizeRotation",function(){return this._tempSizeRotation=new Float32Array(3)},"_tempRadius",function(){return this._tempRadius=new Float32Array(2)},"_tempRadian",function(){return this._tempRadian=new Float32Array(4)}]),u}(),R=function(){function t(){this.settings=null,this.texture=null}return n(t,"laya.particle.ParticleTemplateBase"),t.prototype.addParticleArray=function(t,i){},t}(),S=function(){function i(){}return n(i,"laya.particle.particleUtils.PicTool"),i.getCanvasPic=function(t,i){t=t.bitmap;var e=new u,a=e.getContext("2d");e.size(t.width,t.height);var r=i>>16&255,n=i>>8&255,s=255&i;if(_.isConchApp&&a.setFilter(r/255,n/255,s/255,0),a.drawImage(t.source||t._source,0,0),!_.isConchApp){for(var o=a.getImageData(0,0,e.width,e.height),l=o.data,h=0,c=l.length;h<c;h+=4)0!=l[h+3]&&(l[h]=r,l[h+1]=n,l[h+2]=s);a.putImageData(o,0,0)}return e},i.getRGBPic=function(t){return[new y(i.getCanvasPic(t,16711680)),new y(i.getCanvasPic(t,65280)),new y(i.getCanvasPic(t,255))]},i}(),A=function(){function t(){this._frameTime=0,this._emissionRate=60,this._emissionTime=0,this.minEmissionTime=1/60,this._particleTemplate=null}n(t,"laya.particle.emitter.EmitterBase");var i=t.prototype;return i.start=function(t){void 0===t&&(t=Number.MAX_VALUE),0!=this._emissionRate&&(this._emissionTime=t)},i.stop=function(){this._emissionTime=0},i.clear=function(){this._emissionTime=0},i.emit=function(){},i.advanceTime=function(t){if(void 0===t&&(t=1),this._emissionTime-=t,!(this._emissionTime<0||(this._frameTime+=t,this._frameTime<this.minEmissionTime)))for(;this._frameTime>this.minEmissionTime;)this._frameTime-=this.minEmissionTime,this.emit()},s(0,i,"particleTemplate",null,function(t){this._particleTemplate=t}),s(0,i,"emissionRate",function(){return this._emissionRate},function(t){t<=0||0<(this._emissionRate=t)&&(this.minEmissionTime=1/t)}),t}(),w=function(){function t(){this.maxIndex=0,this.cmds=null,this.id=0}return n(t,"laya.particle.particleUtils.CMDParticle"),t.prototype.setCmds=function(t){this.cmds=t,this.maxIndex=t.length-1},t}(),V=(function(){function t(t,i,e){this._templet=null,this._timeBetweenParticles=NaN,this._previousPosition=null,this._timeLeftOver=0,this._tempVelocity=new Float32Array([0,0,0]),this._tempPosition=new Float32Array([0,0,0]),this._templet=t,this._timeBetweenParticles=1/i,this._previousPosition=e}n(t,"laya.particle.ParticleEmitter"),t.prototype.update=function(t,i){if(0<(t/=1e3)){m.subtractVector3(i,this._previousPosition,this._tempVelocity),m.scaleVector3(this._tempVelocity,1/t,this._tempVelocity);for(var e=this._timeLeftOver+t,a=-this._timeLeftOver;e>this._timeBetweenParticles;)a+=this._timeBetweenParticles,e-=this._timeBetweenParticles,m.lerpVector3(this._previousPosition,i,a/t,this._tempPosition),this._templet.addParticleArray(this._tempPosition,this._tempVelocity);this._timeLeftOver=e}this._previousPosition[0]=i[0],this._previousPosition[1]=i[1],this._previousPosition[2]=i[2]}}(),function(){function t(){this.u_Duration=NaN,this.u_EndVelocity=NaN,this.u_Gravity=null,this.a_Position=null,this.a_Velocity=null,this.a_StartColor=null,this.a_EndColor=null,this.a_SizeRotation=null,this.a_Radius=null,this.a_Radian=null,this.a_AgeAddScale=NaN,this.gl_Position=null,this.v_Color=null,this.oSize=NaN,this._color=new Float32Array(4),this._position=new Float32Array(3)}n(t,"laya.particle.particleUtils.CanvasShader");var i=t.prototype;return i.getLen=function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},i.ComputeParticlePosition=function(t,i,e,a){this._position[0]=t[0],this._position[1]=t[1],this._position[2]=t[2];var r,n=this.getLen(i),s=n*a+(n*this.u_EndVelocity-n)*a*a/2;r=this.getLen(i);var o=0;for(3,o=0;o<3;o++)this._position[o]=this._position[o]+i[o]/r*s*this.u_Duration,this._position[o]+=this.u_Gravity[o]*e*a;var l=m.lerp(this.a_Radius[0],this.a_Radius[1],a),h=m.lerp(this.a_Radian[0],this.a_Radian[2],a),c=m.lerp(this.a_Radian[1],this.a_Radian[3],a),u=Math.cos(c)*l;return this._position[1]+=Math.sin(c)*l,this._position[0]+=Math.cos(h)*u,this._position[2]+=Math.sin(h)*u,new Float32Array([this._position[0],this._position[1],0,1])},i.ComputeParticleSize=function(t,i,e){return m.lerp(t,i,e)},i.ComputeParticleRotation=function(t,i){return t*i},i.ComputeParticleColor=function(t,i,e){var a=this._color;return m.lerpVector4(t,i,e,a),a[3]=a[3]*e*(1-e)*(1-e)*6.7,a},i.clamp=function(t,i,e){return t<i?i:e<t?e:t},i.getData=function(t){t*=1+this.a_AgeAddScale;var i=this.clamp(t/this.u_Duration,0,1);this.gl_Position=this.ComputeParticlePosition(this.a_Position,this.a_Velocity,t,i);var e=this.ComputeParticleSize(this.a_SizeRotation[0],this.a_SizeRotation[1],i),a=this.ComputeParticleRotation(this.a_SizeRotation[2],t);this.v_Color=this.ComputeParticleColor(this.a_StartColor,this.a_EndColor,i);var r,n=new c;r=e/this.oSize*2,n.scale(r,r),n.rotate(a),n.setTranslate(this.gl_Position[0],-this.gl_Position[1]);var s;return s=this.v_Color[3],[this.v_Color,s,n,this.v_Color[0]*s,this.v_Color[1]*s,this.v_Color[2]*s]},t}()),T=function(t){function i(){this.u_CurrentTime=NaN,this.u_Duration=NaN,this.u_Gravity=null,this.u_EndVelocity=NaN,this.u_texture=null,i.__super.call(this,0,0)}return n(i,"laya.particle.shader.value.ParticleShaderValue",C),i.prototype.upload=function(){var t=this.size;t[0]=e.width,t[1]=e.height,this.alpha=this.ALPHA*e.worldAlpha,i.pShader.upload(this)},a(i,["pShader",function(){return this.pShader=new M}]),i}(),z=function(t){function i(t){this.setting=null,this._posRange=null,this._canvasTemplate=null,this._emitFun=null,i.__super.call(this),this.template=t}n(i,"laya.particle.emitter.Emitter2D",t);var e=i.prototype;return e.emit=function(){t.prototype.emit.call(this),null!=this._emitFun&&this._emitFun()},e.getRandom=function(t){return(2*Math.random()-1)*t},e.webGLEmit=function(){var t=new Float32Array(3);t[0]=this.getRandom(this._posRange[0]),t[1]=this.getRandom(this._posRange[1]),t[2]=this.getRandom(this._posRange[2]);var i=new Float32Array(3);i[0]=0,i[1]=0,i[2]=0,this._particleTemplate.addParticleArray(t,i)},e.canvasEmit=function(){var t=new Float32Array(3);t[0]=this.getRandom(this._posRange[0]),t[1]=this.getRandom(this._posRange[1]),t[2]=this.getRandom(this._posRange[2]);var i=new Float32Array(3);i[0]=0,i[1]=0,i[2]=0,this._particleTemplate.addParticleArray(t,i)},s(0,e,"template",function(){return this._particleTemplate},function(t){(this._particleTemplate=t)||(this._emitFun=null,this.setting=null,this._posRange=null),this.setting=t.settings,this._posRange=this.setting.positionVariance,this._particleTemplate instanceof laya.particle.ParticleTemplate2D?this._emitFun=this.webGLEmit:this._particleTemplate instanceof laya.particle.ParticleTemplateCanvas&&(this._canvasTemplate=t,this._emitFun=this.canvasEmit)}),i}(A),F=function(t){function i(t){this._vertices=null,this._mesh=null,this._conchMesh=null,this._floatCountPerVertex=29,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0,i.__super.call(this),this.settings=t}n(i,"laya.particle.ParticleTemplateWebGL",R);var e=i.prototype;return e.reUse=function(t,i){return 0},e.initialize=function(){var t=0;t=_.isConchApp?(this._vertices=this._conchMesh._float32Data,d.const_stride/4):(this._vertices=this._mesh._vb.getFloat32Array(),this._mesh._stride/4);for(var i=0,e=0,a=0;a<this.settings.maxPartices;a++){var r=Math.random(),n=this.settings.textureCount?1/this.settings.textureCount:1,s=NaN;for(s=0;s<this.settings.textureCount&&!(r<s+n);s+=n);this._vertices[i++]=-1,this._vertices[i++]=-1,this._vertices[i++]=0,this._vertices[i++]=s,i=e+=t,this._vertices[i++]=1,this._vertices[i++]=-1,this._vertices[i++]=1,this._vertices[i++]=s,i=e+=t,this._vertices[i++]=1,this._vertices[i++]=1,this._vertices[i++]=1,this._vertices[i++]=s+n,i=e+=t,this._vertices[i++]=-1,this._vertices[i++]=1,this._vertices[i++]=0,this._vertices[i++]=s+n,i=e+=t}},e.update=function(t){this._currentTime+=t/1e3,this.retireActiveParticles(),this.freeRetiredParticles(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0)},e.retireActiveParticles=function(){for(var t=this.settings.duration;this._firstActiveElement!=this._firstNewElement;){var i=this._firstActiveElement*this._floatCountPerVertex*4,e=i+28,a=this._currentTime-this._vertices[e];if((a*=1+this._vertices[i+27])+1e-4<t)break;this._vertices[e]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.settings.maxPartices&&(this._firstActiveElement=0)}},e.freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){if(this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*4+28]<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this.settings.maxPartices&&(this._firstRetiredElement=0)}},e.addNewParticlesToVertexBuffer=function(){},e.addParticleArray=function(t,i){var e=this._firstFreeElement+1;if(e>=this.settings.maxPartices&&(e=0),e!==this._firstRetiredElement){for(var a=E.Create(this.settings,t,i,this._currentTime),r=this._firstFreeElement*this._floatCountPerVertex*4,n=0;n<4;n++){var s=0,o=0;for(s=0,o=4;s<3;s++)this._vertices[r+n*this._floatCountPerVertex+o+s]=a.position[s];for(s=0,o=7;s<3;s++)this._vertices[r+n*this._floatCountPerVertex+o+s]=a.velocity[s];for(s=0,o=10;s<4;s++)this._vertices[r+n*this._floatCountPerVertex+o+s]=a.startColor[s];for(s=0,o=14;s<4;s++)this._vertices[r+n*this._floatCountPerVertex+o+s]=a.endColor[s];for(s=0,o=18;s<3;s++)this._vertices[r+n*this._floatCountPerVertex+o+s]=a.sizeRotation[s];for(s=0,o=21;s<2;s++)this._vertices[r+n*this._floatCountPerVertex+o+s]=a.radius[s];for(s=0,o=23;s<4;s++)this._vertices[r+n*this._floatCountPerVertex+o+s]=a.radian[s];this._vertices[r+n*this._floatCountPerVertex+27]=a.durationAddScale,this._vertices[r+n*this._floatCountPerVertex+28]=a.time}this._firstFreeElement=e}},i}(),b=function(t){function i(t){this._ready=!1,this.textureList=[],this.particleList=[],this.pX=0,this.pY=0,this.activeParticles=[],this.deadParticles=[],this.iList=[],this._maxNumParticles=0,this.textureWidth=NaN,this.dTextureWidth=NaN,this.colorChange=!0,this.step=1/60,this.canvasShader=new V,i.__super.call(this),this.settings=t,this._maxNumParticles=t.maxPartices,this.texture=new y,this.texture.on("ready",this,this._textureLoaded),this.texture.load(t.textureName)}n(i,"laya.particle.ParticleTemplateCanvas",R);var e=i.prototype;return e._textureLoaded=function(t){this.setTexture(this.texture),this._ready=!0},e.clear=function(t){void 0===t&&(t=!0),this.deadParticles.length=0,this.activeParticles.length=0,this.textureList.length=0},e.setTexture=function(t){this.texture=t,this.textureWidth=t.width,this.dTextureWidth=1/this.textureWidth,this.pX=.5*-t.width,this.pY=.5*-t.height,this.textureList=i.changeTexture(t,this.textureList),this.particleList.length=0,this.deadParticles.length=0,this.activeParticles.length=0},e._createAParticleData=function(t,i){var e;this.canvasShader.u_EndVelocity=this.settings.endVelocity,this.canvasShader.u_Gravity=this.settings.gravity,this.canvasShader.u_Duration=this.settings.duration,e=E.Create(this.settings,t,i,0),this.canvasShader.a_Position=e.position,this.canvasShader.a_Velocity=e.velocity,this.canvasShader.a_StartColor=e.startColor,this.canvasShader.a_EndColor=e.endColor,this.canvasShader.a_SizeRotation=e.sizeRotation,this.canvasShader.a_Radius=e.radius,this.canvasShader.a_Radian=e.radian,this.canvasShader.a_AgeAddScale=e.durationAddScale,this.canvasShader.oSize=this.textureWidth;var a=new w,r=0,n=this.settings.duration/(1+e.durationAddScale),s=[];for(r=0;r<n;r+=this.step)s.push(this.canvasShader.getData(r));return a.id=this.particleList.length,this.particleList.push(a),a.setCmds(s),a},e.addParticleArray=function(t,i){var e;this._ready&&(this.particleList.length<this._maxNumParticles?(e=this._createAParticleData(t,i),this.iList[e.id]=0,this.activeParticles.push(e)):0<this.deadParticles.length&&(e=this.deadParticles.pop(),this.iList[e.id]=0,this.activeParticles.push(e)))},e.advanceTime=function(t){if(void 0===t&&(t=1),this._ready){var i,e=this.activeParticles,a=this.deadParticles,r=0,n=e.length,s=0,o=this.iList;for(r=n-1;-1<r;r--)(s=o[(i=e[r]).id])>=i.maxIndex?(s=0,e.splice(r,1),a.push(i)):s+=1,o[i.id]=s}},e.render=function(t,i,e){this._ready&&(this.activeParticles.length<1||this.textureList.length<2||(this.settings.disableColor?this.noColorRender(t,i,e):this.canvasRender(t,i,e)))},e.noColorRender=function(t,i,e){var a,r,n,s=this.activeParticles,o=0,l=s.length,h=NaN,c=this.pX,u=this.pY,m=2*-c,d=2*-u,_=0,p=(this.textureList,this.iList);for(t.translate(i,e),n=t.globalAlpha,o=0;o<l;o++)_=p[(a=s[o]).id],(r=a.cmds[_])&&((h=r[1])<=.01||(t.globalAlpha=n*h,t.drawTextureWithTransform(this.texture,c,u,m,d,r[2],0,0,1,null)));t.globalAlpha=n,t.translate(-i,-e)},e.canvasRender=function(t,i,e){var a,r,n,s,o=this.activeParticles,l=0,h=o.length,c=this.pX,u=this.pY,m=2*-c,d=2*-u,_=0,p=this.textureList,f=this.iList;for(t.translate(i,e),n=t.globalAlpha,s=t.globalCompositeOperation,t.globalCompositeOperation="lighter",l=0;l<h;l++)_=f[(a=o[l]).id],(r=a.cmds[_])&&(r[1]<=.01||(t.save(),t.transformByMatrix(r[2],0,0),.01<r[3]&&(t.globalAlpha=n*r[3],t.drawTexture(p[0],c,u,m,d)),.01<r[4]&&(t.globalAlpha=n*r[4],t.drawTexture(p[1],c,u,m,d)),.01<r[5]&&(t.globalAlpha=n*r[5],t.drawTexture(p[2],c,u,m,d)),t.restore()));t.globalAlpha=n,t.translate(-i,-e),t.globalCompositeOperation=s},i.changeTexture=function(t,i,e){return i||(i=[]),i.length=0,e&&e.disableColor?i.push(t,t,t):g.copyArray(i,S.getRGBPic(t)),i},i}(),N=function(e){function a(t){this.x=0,this.y=0,this._blendFn=null,this._startTime=0,this._key={},this.sv=new T,a.__super.call(this,t);var i=this;if(r.loader.load(this.settings.textureName,h.create(null,function(t){i.texture=t})),this.sv.u_Duration=this.settings.duration,this.sv.u_Gravity=this.settings.gravity,this.sv.u_EndVelocity=this.settings.endVelocity,this._blendFn=o.fns[t.blendState],_.isConchApp){var e=d.const_stride*this.settings.maxPartices*4*4;this._conchMesh=new ParamData(e,!0)}else this._mesh=d.getAMesh(this.settings.maxPartices);this.initialize()}n(a,"laya.particle.ParticleTemplate2D",e);var t=a.prototype;return r.imps(t,{"laya.webgl.submit.ISubmit":!0}),t.getRenderType=function(){return-111},t.releaseRender=function(){},t.addParticleArray=function(t,i){t[0]+=this.x,t[1]+=this.y,e.prototype.addParticleArray.call(this,t,i)},t.addNewParticlesToVertexBuffer=function(){var t=this._mesh._vb;t.clear(),t.append(this._vertices);var i=0;this._firstNewElement<this._firstFreeElement?(i=4*this._firstNewElement*this._floatCountPerVertex*4,t.subUpload(i,i,i+4*(this._firstFreeElement-this._firstNewElement)*this._floatCountPerVertex*4)):(i=4*this._firstNewElement*this._floatCountPerVertex*4,t.subUpload(i,i,i+4*(this.settings.maxPartices-this._firstNewElement)*this._floatCountPerVertex*4),0<this._firstFreeElement&&(t.setNeedUpload(),t.subUpload(0,0,4*this._firstFreeElement*this._floatCountPerVertex*4))),this._firstNewElement=this._firstFreeElement},t.renderSubmit=function(){if(this.texture&&this.texture.getIsReady()){if(this.update(r.timer._delta),this.sv.u_CurrentTime=this._currentTime,this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this.blend(),this._firstActiveElement!=this._firstFreeElement){var t=x.mainContext;this._mesh.useMesh(t),this.sv.u_texture=this.texture._getSource(),this.sv.upload(),this._firstActiveElement<this._firstFreeElement?x.mainContext.drawElements(4,6*(this._firstFreeElement-this._firstActiveElement),5123,6*this._firstActiveElement*2):(x.mainContext.drawElements(4,6*(this.settings.maxPartices-this._firstActiveElement),5123,6*this._firstActiveElement*2),0<this._firstFreeElement&&x.mainContext.drawElements(4,6*this._firstFreeElement,5123,0)),v.renderBatch++}this._drawCounter++}return 1},t.updateParticleForNative=function(){this.texture&&this.texture.getIsReady()&&(this.update(r.timer._delta),this.sv.u_CurrentTime=this._currentTime,this._firstNewElement!=this._firstFreeElement&&(this._firstNewElement=this._firstFreeElement))},t.getMesh=function(){return this._mesh},t.getConchMesh=function(){return this._conchMesh},t.getFirstNewElement=function(){return this._firstNewElement},t.getFirstFreeElement=function(){return this._firstFreeElement},t.getFirstActiveElement=function(){return this._firstActiveElement},t.getFirstRetiredElement=function(){return this._firstRetiredElement},t.setFirstFreeElement=function(t){this._firstFreeElement=t},t.setFirstNewElement=function(t){this._firstNewElement=t},t.addDrawCounter=function(){this._drawCounter++},t.blend=function(){if(o.activeBlendFunction!==this._blendFn){var t=x.mainContext;t.enable(3042),this._blendFn(t),o.activeBlendFunction=this._blendFn}},t.dispose=function(){_.isConchApp||this._mesh.releaseMesh()},a.activeBlendType=-1,a}(F),M=(function(i){function e(t){this._matrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this._particleTemplate=null,this._canvasTemplate=null,this._emitter=null,this.autoPlay=!0,this.tempCmd=null,e.__super.call(this),this.customRenderEnable=!0,t&&this.setParticleSetting(t)}n(e,"laya.particle.Particle2D",i);var t=e.prototype;t.load=function(t){r.loader.load(t,h.create(this,this.setParticleSetting),null,"json")},t.setParticleSetting=function(t){if(!t)return this.stop();if(P.checkSetting(t),_.isConchApp){this._particleTemplate=new N(t);var i=o.NAMES[t.blendState];this.blendMode=i,this.tempCmd=this.graphics._saveToCmd(null,l.create.call(this.graphics,this._particleTemplate)),this._setGraphicsCallBack()}else _.isWebGL?(this.customRenderEnable=!0,this._particleTemplate=new N(t),this.graphics._saveToCmd(null,l.create(this._particleTemplate))):this._particleTemplate=this._canvasTemplate=new b(t);this._emitter?this._emitter.template=this._particleTemplate:this._emitter=new z(this._particleTemplate),this.autoPlay&&(this.emitter.start(),this.play())},t.play=function(){r.timer.frameLoop(1,this,this._loop)},t.stop=function(){r.timer.clear(this,this._loop)},t._loop=function(){this.advanceTime(1/60)},t.advanceTime=function(t){void 0===t&&(t=1),this._canvasTemplate&&this._canvasTemplate.advanceTime(t),this._emitter&&this._emitter.advanceTime(t)},t.customRender=function(t,i,e){_.isWebGL&&(this._matrix4[0]=t._curMat.a,this._matrix4[1]=t._curMat.b,this._matrix4[4]=t._curMat.c,this._matrix4[5]=t._curMat.d,this._matrix4[12]=t._curMat.tx,this._matrix4[13]=t._curMat.ty,this._particleTemplate.sv.u_mmat=this._matrix4);this._canvasTemplate&&this._canvasTemplate.render(t,i,e)},t.destroy=function(t){void 0===t&&(t=!0),this._particleTemplate instanceof laya.particle.ParticleTemplate2D&&this._particleTemplate.dispose(),i.prototype.destroy.call(this,t)},s(0,t,"url",null,function(t){this.load(t)}),s(0,t,"emitter",function(){return this._emitter})}(f),function(t){function i(){i.__super.call(this,i.vs,i.ps,"ParticleShader",null,["a_CornerTextureCoordinate",0,"a_Position",1,"a_Velocity",2,"a_StartColor",3,"a_EndColor",4,"a_SizeRotation",5,"a_Radius",6,"a_Radian",7,"a_AgeAddScale",8,"a_Time",9])}return n(i,"laya.particle.shader.ParticleShader",p),a(i,["vs",function(){return this.vs="attribute vec4 a_CornerTextureCoordinate;\nattribute vec3 a_Position;\nattribute vec3 a_Velocity;\nattribute vec4 a_StartColor;\nattribute vec4 a_EndColor;\nattribute vec3 a_SizeRotation;\nattribute vec2 a_Radius;\nattribute vec4 a_Radian;\nattribute float a_AgeAddScale;\nattribute float a_Time;\n\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\n\nuniform float u_CurrentTime;\nuniform float u_Duration;\nuniform float u_EndVelocity;\nuniform vec3 u_Gravity;\n\nuniform vec2 size;\nuniform mat4 u_mmat;\n\nvec4 ComputeParticlePosition(in vec3 position, in vec3 velocity,in float age,in float normalizedAge)\n{\n\n   float startVelocity = length(velocity);//起始标量速度\n   float endVelocity = startVelocity * u_EndVelocity;//结束标量速度\n\n   float velocityIntegral = startVelocity * normalizedAge +(endVelocity - startVelocity) * normalizedAge *normalizedAge/2.0;//计算当前速度的标量（单位空间），vt=v0*t+(1/2)*a*(t^2)\n   \n   vec3 addPosition = normalize(velocity) * velocityIntegral * u_Duration;//计算受自身速度影响的位置，转换标量到矢量    \n   addPosition += u_Gravity * age * normalizedAge;//计算受重力影响的位置\n   \n   float radius=mix(a_Radius.x, a_Radius.y, normalizedAge); //计算粒子受半径和角度影响（无需计算角度和半径时，可用宏定义优化屏蔽此计算）\n   float radianHorizontal =mix(a_Radian.x,a_Radian.z,normalizedAge);\n   float radianVertical =mix(a_Radian.y,a_Radian.w,normalizedAge);\n   \n   float r =cos(radianVertical)* radius;\n   addPosition.y += sin(radianVertical) * radius;\n\t\n   addPosition.x += cos(radianHorizontal) *r;\n   addPosition.z += sin(radianHorizontal) *r;\n  \n   addPosition.y=-addPosition.y;//2D粒子位置更新需要取负，2D粒子坐标系Y轴正向朝上\n   position+=addPosition;\n   return  vec4(position,1.0);\n}\n\nfloat ComputeParticleSize(in float startSize,in float endSize, in float normalizedAge)\n{    \n    float size = mix(startSize, endSize, normalizedAge);\n    return size;\n}\n\nmat2 ComputeParticleRotation(in float rot,in float age)\n{    \n    float rotation =rot * age;\n    //计算2x2旋转矩阵.\n    float c = cos(rotation);\n    float s = sin(rotation);\n    return mat2(c, -s, s, c);\n}\n\nvec4 ComputeParticleColor(in vec4 startColor,in vec4 endColor,in float normalizedAge)\n{\n\tvec4 color=mix(startColor,endColor,normalizedAge);\n    //硬编码设置，使粒子淡入很快，淡出很慢,6.7的缩放因子把置归一在0到1之间，可以谷歌x*(1-x)*(1-x)*6.7的制图表\n    color.a *= normalizedAge * (1.0-normalizedAge) * (1.0-normalizedAge) * 6.7;\n   \n    return color;\n}\n\nvoid main()\n{\n   float age = u_CurrentTime - a_Time;\n   age *= 1.0 + a_AgeAddScale;\n   float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   gl_Position = ComputeParticlePosition(a_Position, a_Velocity, age, normalizedAge);//计算粒子位置\n   float pSize = ComputeParticleSize(a_SizeRotation.x,a_SizeRotation.y, normalizedAge);\n   mat2 rotation = ComputeParticleRotation(a_SizeRotation.z, age);\n\t\n    mat4 mat=u_mmat;\n    gl_Position=vec4((mat*gl_Position).xy,0.0,1.0);\n    gl_Position.xy += (rotation*a_CornerTextureCoordinate.xy) * pSize*vec2(mat[0][0],mat[1][1]);\n    gl_Position=vec4((gl_Position.x/size.x-0.5)*2.0,(0.5-gl_Position.y/size.y)*2.0,0.0,1.0);\n   \n   v_Color = ComputeParticleColor(a_StartColor,a_EndColor, normalizedAge);\n   v_TextureCoordinate =a_CornerTextureCoordinate.zw;\n}\n\n"},"ps",function(){return this.ps="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\n\nvoid main()\n{\t\n\tgl_FragColor=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n\tgl_FragColor.xyz *= v_Color.w;\n}"}]),i}())}(window,document,Laya);